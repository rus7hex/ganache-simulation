import Ganache from "ganache";
import { parseLog } from "./contract.js";


const account = "0x7f94a22cfcbfed34e790edb2516af9cde2050c6d";
const contract = "0x000000000000ad05ccc4f10045630fb830b95127";


const ganache = Ganache.provider({
    chain: {
        asyncRequestProcessing: false,
    },
    wallet: {
        totalAccounts: 0,
        unlockedAccounts: [account]
    },
    fork: {
        url: "https://eth.llamarpc.com",
        blockNumber: 16668399 - 3,
        disableCache: true,
        deleteCache: true,
    }
});

const balance = await ganache.send("eth_getBalance", [account]);
console.log(parseInt(balance, 16) / 1e18);

const txid = await ganache.send("eth_sendTransaction", [{
    from: account,
    to: contract,
    data: "0xb3be57f800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000007e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001bf15eca0bfc6e3fe8cd8f2c7b795316947f8c20078f5ae8f7cdcb123847cce58c6d3b22a3f357dd06234ab6bf6bb35e76d7964208defa65021f17807d5b96f1f6000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000fe56ed0000000000000000000000001a51bcbc8d3642680d8267550f54e6e4cc5c498400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000dab4a563819e8fd93dba3b25bc349500000000000000000000000034d85c9cdeb23fa97cb08333b511ac86e1c4e25800000000000000000000000000000000000000000000000000000000000155da000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bf2197b203440000000000000000000000000000000000000000000000000000000000063f31f800000000000000000000000000000000000000000000000000000000063f7140000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000b5215833005a3674cd7074087c10058200000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000003200000000000000000000000037ceb4ba093d40234c6fb312d9791b67c04ef49a0000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000001c174894b92ac4b043dde7b9eea542321af588dbc4d2ad9595e639a8a8c1efe8c729f9c9bb307d723980cb276112e12e4bae0cbf4a20e011cdd3b95df9a0ecf6a70000000000000000000000000000000000000000000000000000000000000001477c8ea620594d1ddfe04094b4e2a093ddcdf071af0efd5567bb09f054fa853a00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fe56ed0000000000000000000000007f94a22cfcbfed34e790edb2516af9cde2050c6d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dab4a563819e8fd93dba3b25bc349500000000000000000000000034d85c9cdeb23fa97cb08333b511ac86e1c4e25800000000000000000000000000000000000000000000000000000000000155da000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bf2197b203440000000000000000000000000000000000000000000000000000000000063f31f810000000000000000000000000000000000000000000000000000000063f334f100000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000a94d310c0c1a8a82c965b4b5ba6a883b00000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000001c3d1b488500cab1367a2a9f0b41aaa4924bd70ceb7b0976ef07426ab2f07cc3f1297a80d7a4e07918f9a3e6095a1da86cbc5ff25b0ee27e57110bd2df40985cc40000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001bf15eca0bfc6e3fe8cd8f2c7b795316947f8c20078f5ae8f7cdcb123847cce58c6d3b22a3f357dd06234ab6bf6bb35e76d7964208defa65021f17807d5b96f1f6000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000fe56ed0000000000000000000000001a51bcbc8d3642680d8267550f54e6e4cc5c498400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000dab4a563819e8fd93dba3b25bc349500000000000000000000000034d85c9cdeb23fa97cb08333b511ac86e1c4e2580000000000000000000000000000000000000000000000000000000000015703000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bf2197b203440000000000000000000000000000000000000000000000000000000000063f31f800000000000000000000000000000000000000000000000000000000063f7140000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000005779bef4910dce110e2eddd7b86f676600000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000003200000000000000000000000037ceb4ba093d40234c6fb312d9791b67c04ef49a0000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000001b14e999dadc29710c93577e492c72131def923e989567bac2ba58425e8d38a5ea19440d5261b24de90595243d716b394796d5b5fa1564fafda193d686a82d1fbd0000000000000000000000000000000000000000000000000000000000000002577c1e915dc2135a0c5fc7050ec82f615e4bc6f8d9e735dc47215549c9be243c942e63102ec970823c1c12ba119d004427235dcfc2d42fd8bd74a75f57de21f000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fe56ed0000000000000000000000007f94a22cfcbfed34e790edb2516af9cde2050c6d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dab4a563819e8fd93dba3b25bc349500000000000000000000000034d85c9cdeb23fa97cb08333b511ac86e1c4e2580000000000000000000000000000000000000000000000000000000000015703000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bf2197b203440000000000000000000000000000000000000000000000000000000000063f31f810000000000000000000000000000000000000000000000000000000063f334f100000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000ae417e0230a6ffafadc7b323505ec9d500000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000001c73a0bb3af57667b5384456137bad6ed9619bb8659e0534cb1f6c737b0337d0a6036c369d6b56f7861abd985886c2349b4455782b9b8b8605c8b494684ff3a5b6",
    value: `0x${(4.03 * 1e18).toString(16)}`,
    gasLimit: 800000
}]);

const receipt = await ganache.send("eth_getTransactionReceipt", [txid]);
console.log(receipt.logs.length)

for (const log of receipt.logs) {
    try {
        const data = parseLog(log);
        const args = {};
        for (const key of Object.keys(data.args).slice(data.eventFragment.inputs.length)) {
            args[key] = data.args[key].toString();
        }
        const event = {
            name: data.name,
            args
        }

        console.log(event);
    } catch (error) {
        // do nothing
    }
}
