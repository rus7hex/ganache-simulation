import Ganache from "ganache";
import { parseLog } from "./contract.js";


const account = "0x5f4f3b95ff0dfdaa9329126f99c3901e19a48bfd";
const contract = "0xef1c6e67703c7bd7107eed8303fbe6ec2554bf6b";


const ganache = Ganache.provider({
    chain: {
        asyncRequestProcessing: false,
    },
    wallet: {
        totalAccounts: 0,
        unlockedAccounts: [account]
    },
    fork: {
        url: "https://eth.llamarpc.com",
        blockNumber: 16668470 - 3,
        disableCache: true,
        deleteCache: true,
    }
});

const balance = await ganache.send("eth_getBalance", [account]);
console.log(parseInt(balance, 16) / 1e18);

const txid = await ganache.send("eth_sendTransaction", [{
    from: account,
    to: contract,
    data: "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000063f3313700000000000000000000000000000000000000000000000000000000000000020b080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000049b38781ad71b1000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000049b38781ad71b10000000000000000000000000000000000000000000439ce390ef1dd6520ff1ce00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000be00734799a67a62af2819825580318ac1b1e4ec",
    value: `0x${(0.34 * 1e18).toString(16)}`,
    gasLimit: 300000
}]);

const receipt = await ganache.send("eth_getTransactionReceipt", [txid]);
console.log(receipt.logs.length)

for (const log of receipt.logs) {
    try {
        const data = parseLog(log);
        const args = { 
            contract: log.address
        };
        for (const key of Object.keys(data.args).slice(data.eventFragment.inputs.length)) {
            args[key] = data.args[key].toString();
        }
        const event = {
            name: data.name,
            args
        }

        console.log(event);
    } catch (error) {
        // do nothing
    }
}
